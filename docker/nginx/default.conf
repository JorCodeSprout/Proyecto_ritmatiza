server {
    listen 80;
    server_name ritmatiza.local;

    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name ritmatiza.local;

    ssl_certificate /etc/nginx/ssl/ritmatiza_local.crt;
    ssl_certificate_key /etc/nginx/ssl/ritmatiza_local.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Directorio raíz del proyecto: CLAVE para que Nginx encuentre /index.php
    root /var/www/html/public;

    index index.php index.html;
    charset utf-8;

    # Bloque de reescritura de URLs para Laravel
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Bloque de procesamiento PHP-FPM
    location ~ \.php$ {
        # Esta línea asegura que la solicitud FastCGI va al servidor PHP-FPM
        fastcgi_pass app:9000;
        
        # Incluye todos los parámetros FastCGI estándar (CRUCIAL para REQUEST_URI)
        include fastcgi_params;

        # 1. Fuerza la variable SCRIPT_FILENAME para que PHP-FPM sepa qué archivo ejecutar.
        # Utilizamos $document_root para mayor compatibilidad con la directiva 'root'.
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # 2. Establecer SCRIPT_NAME de manera explícita (Ayuda a Laravel enrutar)
        fastcgi_param SCRIPT_NAME /index.php;

        # 3. Eliminar cualquier límite de buffer que pueda causar 404s en Postman
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        
        # Parámetros adicionales para seguridad y ruteo
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # Bloque para denegar acceso a archivos ocultos (ej. .htaccess o .env)
    location ~ /\.ht|/\.env {
        deny all;
    }

    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
}
